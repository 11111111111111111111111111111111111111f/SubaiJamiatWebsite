<!DOCTYPE html>
<html lang="en" class="no-fs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/dashboard/dashboard.css">
    <!-- fontawesome cdn link  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

    <meta name="robots" content="noindex">

    <title>Admin</title>
</head>

<body data-page="Tausia">

    <div class=" main-container">

        <div class="mobile-dashboard"></div>

        <%- include('../common/dashboard-sidebar') %>

            <div class="right">

                <%- include('../common/dashboard-header') %>

                    <div class="content">
                        <div class="page">
                            <span>
                                <span class="bold">Dashboard</span>
                                <i class="fa-solid fa-angle-right icon"></i>
                            </span>
                            <span>
                                Tausia Registeration
                                <i class="fa-solid fa-angle-right icon"></i>
                            </span>
                            <span>

                                Approved

                            </span>
                        </div>
                        <div class="table">
                            <div class="header no-input">
                                <h3 class="heading">
                                    Tausia Registeration
                                </h3>

                                <!-- <div class="input">
                                    <i class="fa-solid fa-magnifying-glass search-icon "></i>
                                    <input type="text" placeholder="Search students here">
                                </div> -->

                            </div>
                            <div class="student-table-container">
                                <table class="student-table">
                                    <tr>
                                        <th>
                                            userId
                                        </th>
                                        <th>
                                            Date
                                        </th>
                                        <th>
                                            Qism
                                        </th>
                                        <th>
                                            Braye
                                        </th>
                                        <th>
                                            MasjidMadarsaName
                                        </th>
                                        <th>
                                            MasjidMadarsaAddress
                                        </th>
                                        <th>
                                            SocietyTrustName
                                        </th>
                                        <th>
                                            TotalNumberOfStudents
                                        </th>
                                        <th>
                                            TotalNumberOfAqamtiStudents
                                        </th>
                                        <th>
                                            SocietyTrustPresidentNameNumber
                                        </th>
                                        <th>
                                            SocietyTrustSecretarieNameNumber
                                        </th>
                                        <th>
                                            SafeerName
                                        </th>
                                        <th>
                                            SafeerNumber
                                        </th>

                                        <th>
                                            DistrictJamiatAmirNazimNameNumber
                                        </th>
                                        <th>
                                            SubaiJamiatAmirNazimNameNumber
                                        </th>
                                        <th>
                                            SafeerImage
                                        </th>
                                        <th>
                                            Document
                                        </th>
                                        <th>
                                            TausiaReason
                                        </th>
                                        <th>
                                            Status
                                        </th>
                                        <th>
                                            Update
                                        </th>
                                        <th>
                                            Download Pdf
                                        </th>
                                        <th>
                                            Upload Image
                                        </th>
                                        <th>
                                            Upload Tausia Id
                                        </th>
                                        <th>
                                            Tausia Expiry Date
                                        </th>
                                        <th>
                                            Upload Btn
                                        </th>
                                        <th>
                                            Reject
                                        </th>

                                    </tr>
                                    <% if(TausiaData.length> 0){ %>
                                        <% TausiaData.forEach(value=>{ %>

                                            <tr>
                                                <td class="no-break">
                                                    <%= value.userId %>
                                                </td>
                                                <td class="no-break">
                                                    <%= value.date %>
                                                </td>
                                                <td>
                                                    <%= value.Qism %>
                                                </td>
                                                <td>
                                                    <%= value.Braye %>
                                                </td>
                                                <td>
                                                    <%= value.MasjidMadarsaName %>
                                                </td>
                                                <td>
                                                    <%= value.MasjidMadarsaAddress %>
                                                </td>
                                                <td>
                                                    <%= value.SocietyTrustName %>
                                                </td>
                                                <td>
                                                    <%= value.TotalNumberOfStudents %>
                                                </td>
                                                <td>
                                                    <%= value.TotalNumberOfAqamtiStudents %>
                                                </td>
                                                <td>
                                                    <%= value.SocietyTrustPresidentNameNumber %>
                                                </td>
                                                <td>
                                                    <%= value.SocietyTrustSecretarieNameNumber %>
                                                </td>
                                                <td>
                                                    <%= value.SafeerName %>
                                                </td>
                                                <td>
                                                    <%= value.SafeerNumber %>
                                                </td>
                                                <td>
                                                    <%= value.DistrictJamiatAmirNazimNameNumber %>
                                                </td>
                                                <td>
                                                    <%= value.SubaiJamiatAmirNazimNameNumber %>
                                                </td>
                                                <td>
                                                    <a class="btn btn-primary btn-sm" target="_blank"
                                                        href="./tausia-images/<%= value.SafeerImage %>">
                                                        Show Image
                                                    </a>
                                                </td>
                                                <td>
                                                    <a class="btn btn-primary btn-sm" target="_blank"
                                                        href="./tausia-documents/<%= value.Document %>">
                                                        Show Documents
                                                    </a>
                                                </td>
                                                <td class="large-column">
                                                    <%= value.TausiaReason %>
                                                </td>
                                                <td>
                                                    <input class="status-input input-field" data-id="<%= value._id %>"
                                                        type="text" value="<%= value.status %>">
                                                </td>
                                                <td>
                                                    <button data-id="<%= value._id %>"
                                                        class="btn text-white btn-warning update-btn btn-sm">Update
                                                        Status</button>
                                                </td>
                                                <td>
                                                    <button data-id="<%= value._id %>"
                                                        class="btn btn-primary btn-sm download-pdf-btn">
                                                        Download Pdf
                                                    </button>
                                                </td>
                                                <td>
                                                    <input type="file" class="file tausia-file-input"
                                                        data-id="<%= value._id %>">
                                                </td>
                                                <td>
                                                    <input type="text" class="tausia-id input-field"
                                                        data-id="<%= value._id %>">
                                                </td>
                                                <td>
                                                    <input type="date" class="tausia-expiry-date  input-field"
                                                        data-id="<%= value._id %>">
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-primary upload-btn btn-small"
                                                        data-id="<%= value._id %>">
                                                        Upload
                                                    </button>
                                                </td>
                                                <td>
                                                    <button data-id="<%= value._id %>" class=" btn btn-danger reject">
                                                        Reject
                                                    </button>
                                                </td>
                                            </tr>

                                            <% }) %>
                                                <% }else{ %>
                                                    <tr>
                                                        <td colspan="25">
                                                            No Data Present
                                                        </td>
                                                    </tr>
                                                    <% } %>
                                </table>
                            </div>
                            <div class="pagination">
                                <% if(pagination.page> 1) {%>
                                    <a href="tausia-approved?page=<%= pagination.page-1 %>">
                                        <i class="fa-solid fa-angle-left"></i>
                                    </a>
                                    <% }else{ %>
                                        <a href="" class="inactive">
                                            <i class="fa-solid fa-angle-left"></i>
                                        </a>
                                        <% } %>

                                            <span>
                                                <%= pagination.page %> of <%= pagination.endPage %>
                                            </span>

                                            <% if(pagination.endPage> pagination.page){ %>
                                                <a href="/tausia-approved?page=<%= pagination.page+1 %>">
                                                    <i class="fa-solid fa-angle-right"></i>
                                                </a>

                                                <% }else{ %>
                                                    <a href="" class="inactive">
                                                        <i class="fa-solid fa-angle-right"></i>
                                                    </a>
                                                    <% } %>


                            </div>
                        </div>
                    </div>
            </div>
    </div>

    <script src="./javascript/dashboard/dashboard.js"></script>
    <script src="./javascript/tausia-reject.js"></script>
    <script src="./javascript/update-status.js"></script>
    <script>

        const uploadBtns = document.querySelectorAll( '.upload-btn' )
        const files = document.querySelectorAll( '.file' )
        const tausiaExpiryDateInput = document.querySelectorAll( '.tausia-expiry-date' )

        tausiaExpiryDateInput.forEach( ( input ) => {
            let today = new Date();
            input.min = today.getFullYear() + "-" + ( today.getMonth() + 1 ) + "-" + today.getDate();
        } )

        uploadBtns.forEach( btn => {

            btn.onclick = () => {

                let id = btn.getAttribute( 'data-id' )

                let input = document.querySelector( `.tausia-id[data-id="${ id }"]` );

                let expiryDate = document.querySelector( `.tausia-expiry-date[data-id="${ id }"]` );

                let file = document.querySelector( `.file[data-id="${ id }"]` );

                if ( file.files[ 0 ] == undefined ) {

                    alert( 'Please upload file' )
                    return

                } else if ( file.files[ 0 ].type != 'image/jpeg' && file.files[ 0 ].type != 'image/jpg' && file.files[ 0 ].type != 'image/png' ) {

                    alert( 'Please upload jpeg or jpg or png image' )
                    return

                } else if ( file.files[ 0 ].type == 'image/jpeg' || file.files[ 0 ].type == 'image/jpg' || file.files[ 0 ].type == 'image/png' ) {

                    let sizeInKb = file.files[ 0 ].size
                    let sizeInMb = Math.ceil( sizeInKb / 1024 )

                    if ( sizeInMb > 1024 ) {
                        alert( 'Image size should be less than  1mb' );
                        return;
                    }
                }

                if ( input.value == '' || input.value.trim().length == 0 ) {
                    alert( "Please upload tausia-id" );
                    return;
                }

                if ( expiryDate.value.length == 0 || expiryDate.value == "" ) {
                    alert( "Please Enter Tausia Expiry Date" );
                    return;
                }


                const InputFile = new File( [ file.files[ 0 ] ], file.files[ 0 ].name, { type: file.files[ 0 ].type } )

                let formData = new FormData();
                formData.append( 'image', InputFile );
                formData.append( 'id', id );
                formData.append( 'tausiaId', input.value.trim() );
                let tempDate = expiryDate.value.split( '-' );
                let convertedExpiryDate = tempDate[ 0 ] + "-" + tempDate[ 1 ] + "-" + tempDate[ 2 ]//year + "-"  + month + "-" + day
                formData.append( "expiryDate", convertedExpiryDate );

                fetch( '/tausia-authentication-image', {
                    method: 'post',
                    body: formData
                } ).then( response => {
                    return response.json()
                } ).then( response => {

                    if ( response.status == 'success' ) {

                        location.reload()

                    } else {

                        location.href = '/error'

                    }

                } )



            }

        } )




    </script>

</body>

</html>